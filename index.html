<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesora de Diseño IA: Aria - YAN'Z SMART WOOD</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Roboto+Slab:wght@700;800&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .font-display { font-family: 'Roboto Slab', serif; }
        .text-shadow-strong { text-shadow: 1px 1px 8px rgba(0, 0, 0, 0.9); }
        .media-background { @apply object-cover object-center w-full h-full; }
        .pill-button { @apply bg-white/10 backdrop-blur-sm text-white border border-white/50 rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-wider hover:bg-white hover:text-black transition-all duration-300; }
        .loader { width: 48px; height: 48px; border: 5px solid; border-color: #ffffff transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; text-shadow: none; }
        .button-loader { width: 20px; height: 20px; border: 3px solid; border-color: #000000 transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        #aria-video { filter: brightness(1.75) contrast(1.2); }
        .tip-button, .contact-button { @apply inline-flex w-full sm:w-auto items-center justify-center gap-3 px-5 py-3 text-base font-semibold text-white bg-gray-700/50 border border-gray-600 rounded-lg shadow-sm transition-all duration-200; }
        .tip-button:hover, .contact-button:hover { @apply bg-white text-black border-white; }
        .tip-button img { width: 24px; height: 24px; object-fit: contain; }
        #mic-button.is-listening { color: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-black text-white">

    <div class="fixed top-0 left-0 w-full h-full z-[-1] bg-black">
        <video loop muted playsinline autoplay class="media-background opacity-50">
             <source src="https://raw.githubusercontent.com/Yanzsmartwood2025/yanzai/main/video-neutral.mp4" type="video/mp4">
        </video>
    </div>

    <header class="absolute top-0 left-0 right-0 p-4 sm:p-5 w-full z-30">
        <div class="flex justify-between items-center w-full">
            <img src="https://raw.githubusercontent.com/Yanzsmartwood2025/yanzai/main/logoyanz.png" alt="YAN'Z SMART WOOD Logo" class="h-8 sm:h-10">
            <button id="install-button" class="hidden items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-lg hover:bg-indigo-500 transition-all duration-300">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                  <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                </svg>
                <span>Instalar App</span>
            </button>
        </div>
    </header>
    
    <div id="aria-container" class="fixed inset-0 z-20 hidden">
        <video id="aria-video" loop muted playsinline class="absolute top-0 left-0 min-w-full min-h-full w-auto h-auto object-cover"></video>
        <div id="video-loader" class="absolute inset-x-0 bottom-0 flex flex-col items-center justify-center pb-12 sm:pb-24 hidden">
            <div class="loader"></div>
            <p id="loading-message" class="text-gray-100 font-semibold text-lg mt-4"></p>
        </div>
    </div>

    <main class="relative w-full min-h-screen flex flex-col items-center justify-center text-center p-4 overflow-hidden">
        <div id="form-container" class="relative z-10 w-full max-w-lg">
            <h1 class="font-display text-4xl sm:text-5xl font-bold tracking-tight text-shadow-strong">Aria</h1>
            <p class="mt-1 text-gray-200">Tu asesora de diseño IA.</p>
            <div class="relative mt-6 w-full">
                <textarea id="prompt-input" rows="3" placeholder="Describe tu visión o presiona el micrófono para hablar..." class="w-full px-5 py-3 pr-12 text-sm bg-white/10 border border-gray-500 rounded-2xl focus:ring-2 focus:ring-indigo-400 focus:outline-none transition duration-200 placeholder:text-gray-400"></textarea>
                <button id="mic-button" title="Usar micrófono" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M12 18.75a6 6 0 006-6v-1.5a6 6 0 00-12 0v1.5a6 6 0 006 6zM12 2.25a.75.75 0 01.75.75v6a.75.75 0 01-1.5 0v-6A.75.75 0 0112 2.25z" />
                        <path d="M12 15a3.75 3.75 0 003.75-3.75v-1.5a3.75 3.75 0 00-7.5 0v1.5A3.75 3.75 0 0012 15z" />
                    </svg>
                </button>
            </div>
            <div class="mt-4">
                <button id="generate-button" class="bg-white text-black font-semibold rounded-full px-8 py-3 hover:bg-gray-200 transition-all duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    <span>Generar Concepto</span>
                </button>
            </div>
            <div id="error-message" class="mt-3 text-red-400 font-medium text-sm h-5"></div>
        </div>
    </main>
    
    <div class="fixed bottom-4 right-4 z-40">
        <button id="open-tip-modal" class="flex items-center gap-2 rounded-full bg-black/50 backdrop-blur-md px-4 py-2 text-sm text-gray-200 shadow-lg ring-1 ring-white/20 hover:bg-black/70 hover:text-white transition-all duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" class="w-4 h-4">
                <path d="M14.5 3h-13a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1zM1 5.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5zM12 8H4v4a4 4 0 0 0 4 4h0a4 4 0 0 0 4-4V8z"/>
                <path d="M13 7.5a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1h1z"/>
            </svg>
            <span>Invítame un café</span>
        </button>
    </div>

    <div id="result-wrapper" class="fixed inset-0 hidden z-40 bg-black/50 backdrop-blur-md overflow-y-auto">
         <div id="result-container" class="w-full max-w-4xl mx-auto my-12 p-4"></div>
    </div>

    <!-- MODALS SECTION -->
    <div id="tip-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden">
        <div class="w-full max-w-md bg-gray-900/80 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-center animate-fade-in">
            <h2 class="font-display text-2xl font-bold text-white mb-2">¡Un café para Aria!</h2>
            <p class="text-gray-300 mb-6">Tu café impulsa la creatividad y mantiene a Aria funcionando. ¡Gracias!</p>
            <div class="flex flex-col gap-4">
                <a href="https://www.paypal.com/paypalme/YanzSmartwoodAria" target="_blank" rel="noopener noreferrer" class="tip-button">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal Logo">
                    <span>Donar con PayPal</span>
                </a>
                <button id="open-peigo-qr-modal" class="tip-button">
                    <img src="https://raw.githubusercontent.com/Yanzsmartwood2025/yanzai/main/peigo.png" alt="Peigo Logo">
                    <span>Pagar con Peigo</span>
                </button>
                <button id="open-deuna-qr-modal" class="tip-button">
                    <img src="https://raw.githubusercontent.com/Yanzsmartwood2025/yanzai/main/deuna.png" alt="Deuna Logo">
                    <span>Enviar con Deuna</span>
                </button>
            </div>
            <button id="close-tip-modal" class="mt-8 text-sm text-gray-400 hover:text-white transition-colors">Cerrar</button>
        </div>
    </div>

    <div id="peigo-qr-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden">
        <div class="w-full max-w-xs bg-white rounded-2xl shadow-2xl p-6 sm:p-8 text-center animate-fade-in relative">
            <button id="close-peigo-qr-modal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-800 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Pagar con Peigo</h3>
            <p class="text-gray-500 text-sm mb-4">Escanea el código con tu app</p>
            <img src="https://raw.githubusercontent.com/Yanzsmartwood2025/yanzai/main/peigo-qr.png" alt="Código QR de Peigo" class="w-full h-auto rounded-lg mx-auto max-w-[250px]">
            <p class="text-gray-700 mt-4 text-sm font-semibold">Aria</p>
        </div>
    </div>

    <div id="deuna-qr-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden">
        <div class="w-full max-w-xs bg-white rounded-2xl shadow-2xl p-6 sm:p-8 text-center animate-fade-in relative">
            <button id="close-deuna-qr-modal" class="absolute top-3 right-4 text-gray-400 hover:text-gray-800 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Pagar con Deuna</h3>
            <p class="text-gray-500 text-sm mb-4">Usa este QR para cobrar</p>
            <img src="https://raw.githubusercontent.com/Yanzsmartwood2025/yanzai/main/deuna-qr.png" alt="Código QR de Deuna" class="w-full h-auto rounded-lg mx-auto max-w-[250px]">
            <p class="text-gray-700 mt-4 text-sm font-semibold">Pagar a Aria</p>
        </div>
    </div>
    
    <div id="contact-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden">
        <div class="w-full max-w-md bg-gray-900/80 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-center animate-fade-in">
            <h2 class="font-display text-2xl font-bold text-white mb-2">Cotización Personalizada</h2>
            <p class="text-gray-300 mb-6">En YAN'Z SMART WOOD, cada diseño es una obra de arte. Para ofrecerte una cotización precisa y ajustada a tu visión, te invitamos a contactar a nuestros especialistas.</p>
            <div class="flex flex-col gap-4">
                <a href="https://wa.me/593984566838" target="_blank" rel="noopener noreferrer" class="contact-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M16.6 14c-.2-.1-1.5-.7-1.7-.8-.2-.1-.4-.1-.6.1-.2.2-.6.7-.8.9-.1.1-.3.2-.5.1-.2-.1-.9-.3-1.8-1.1-.7-.6-1.1-1.4-1.3-1.6-.1-.2 0-.4.1-.5l.5-.6c.1-.1.2-.3.3-.4.1-.1.2-.2.3-.4.1-.2 0-.4-.1-.5-.1-.1-.6-1.5-.8-2-.2-.5-.4-.4-.5-.4h-.5c-.2 0-.4.1-.6.3-.2.2-.8.8-.8 1.9 0 1.1.8 2.2 1 2.4.1.1 1.5 2.3 3.6 3.2.5.2.9.4 1.2.5.5.2 1 .1 1.4-.1.4-.2.6-.9.8-1.1.2-.2.2-.4.1-.5l-.2-.4zM12 2a10 10 0 100 20 10 10 0 000-20z"/></svg>
                    <span>Contactar por WhatsApp</span>
                </a>
                <a href="mailto:yanzsmartwood@gmail.com" class="contact-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M2.25 6.166c0-1.04.84-1.889 1.875-1.889h15.75c1.035 0 1.875.85 1.875 1.89C21.75 7.21 21.053 8 20.25 8H3.75C2.947 8 2.25 7.21 2.25 6.166zM2.25 12c0-1.04.84-1.889 1.875-1.889h15.75c1.035 0 1.875.85 1.875 1.89 0 1.04-.947 1.833-1.875 1.833H3.75c-.947 0-1.5-.794-1.5-1.834zM2.25 17.833c0-1.04.84-1.889 1.875-1.889h15.75c1.035 0 1.875.85 1.875 1.89 0 1.04-.947 1.833-1.875 1.833H3.75c-.947 0-1.5-.794-1.5-1.834z"/></svg>
                    <span>Enviar Correo Electrónico</span>
                </a>
            </div>
            <button id="close-contact-modal" class="mt-8 text-sm text-gray-400 hover:text-white transition-colors">Cerrar</button>
        </div>
    </div>

    <div id="safety-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm hidden">
        <div class="w-full max-w-md bg-gray-900/80 border border-gray-700 rounded-2xl shadow-2xl p-6 sm:p-8 text-center animate-fade-in">
            <h2 class="font-display text-2xl font-bold text-white mb-2">Mi Especialidad es el Diseño</h2>
            <p id="safety-message" class="text-gray-300 mb-6"></p>
            <button id="close-safety-modal" class="bg-white text-black font-semibold rounded-full px-8 py-3 hover:bg-gray-200 transition-all duration-300">Entendido</button>
        </div>
    </div>


    <script>
        // --- Element Selectors ---
        const formContainer = document.getElementById('form-container');
        const resultWrapper = document.getElementById('result-wrapper');
        const resultContainer = document.getElementById('result-container');
        const promptInput = document.getElementById('prompt-input');
        const generateButton = document.getElementById('generate-button');
        const errorMessage = document.getElementById('error-message');
        const ariaContainer = document.getElementById('aria-container');
        const ariaVideo = document.getElementById('aria-video');
        const videoLoader = document.getElementById('video-loader');
        const loadingMessage = document.getElementById('loading-message');
        const tipModal = document.getElementById('tip-modal');
        const openTipModalButton = document.getElementById('open-tip-modal'); 
        const closeTipModalButton = document.getElementById('close-tip-modal');
        const openPeigoQrModalButton = document.getElementById('open-peigo-qr-modal');
        const closePeigoQrModalButton = document.getElementById('close-peigo-qr-modal');
        const peigoQrModal = document.getElementById('peigo-qr-modal');
        const openDeunaQrModalButton = document.getElementById('open-deuna-qr-modal');
        const closeDeunaQrModalButton = document.getElementById('close-deuna-qr-modal');
        const deunaQrModal = document.getElementById('deuna-qr-modal');
        const contactModal = document.getElementById('contact-modal');
        const closeContactModalButton = document.getElementById('close-contact-modal');
        const safetyModal = document.getElementById('safety-modal');
        const closeSafetyModalButton = document.getElementById('close-safety-modal');
        const micButton = document.getElementById('mic-button');
        const installButton = document.getElementById('install-button');

        // --- State ---
        let synth = window.speechSynthesis;
        let hasInteracted = false;
        let originalImagePrompt = '';
        let recognition;
        let deferredInstallPrompt = null;

        // --- PWA Installation Logic ---
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            installButton.style.display = 'flex';
        });

        installButton.addEventListener('click', async () => {
            if (deferredInstallPrompt) {
                deferredInstallPrompt.prompt();
                deferredInstallPrompt = null;
                installButton.style.display = 'none';
            }
        });

        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
        });

        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'es-EC';
            recognition.interimResults = false;

            micButton.addEventListener('click', () => {
                if (micButton.classList.contains('is-listening')) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            });

            recognition.onstart = () => { micButton.classList.add('is-listening'); promptInput.placeholder = "Escuchando..."; };
            recognition.onend = () => { micButton.classList.remove('is-listening'); promptInput.placeholder = "Describe tu visión o presiona el micrófono para hablar..."; };
            recognition.onresult = (event) => { promptInput.value = event.results[0][0].transcript; };
            recognition.onerror = (event) => { console.error("Error de reconocimiento de voz:", event.error); };
        } else {
            micButton.style.display = 'none';
        }

        // --- Event Listeners ---
        openTipModalButton.addEventListener('click', () => tipModal.classList.remove('hidden'));
        closeTipModalButton.addEventListener('click', () => tipModal.classList.add('hidden'));
        tipModal.addEventListener('click', (e) => { if (e.target === tipModal) tipModal.classList.add('hidden'); });
        
        openPeigoQrModalButton.addEventListener('click', () => peigoQrModal.classList.remove('hidden'));
        closePeigoQrModalButton.addEventListener('click', () => peigoQrModal.classList.add('hidden'));
        peigoQrModal.addEventListener('click', (e) => { if (e.target === peigoQrModal) peigoQrModal.classList.add('hidden'); });
        
        openDeunaQrModalButton.addEventListener('click', () => deunaQrModal.classList.remove('hidden'));
        closeDeunaQrModalButton.addEventListener('click', () => deunaQrModal.classList.add('hidden'));
        deunaQrModal.addEventListener('click', (e) => { if (e.target === deunaQrModal) deunaQrModal.classList.add('hidden'); });

        closeContactModalButton.addEventListener('click', () => contactModal.classList.add('hidden'));
        contactModal.addEventListener('click', (e) => { if (e.target === contactModal) contactModal.classList.add('hidden'); });

        closeSafetyModalButton.addEventListener('click', () => safetyModal.classList.add('hidden'));
        safetyModal.addEventListener('click', (e) => { if (e.target === safetyModal) safetyModal.classList.add('hidden'); });

        document.body.addEventListener('click', () => {
            if (!hasInteracted) {
                 speak("Hola, soy Aria, tu asesora de diseño. Describe tu visión y la haré realidad.");
                 hasInteracted = true;
            }
        }, { once: true });

        generateButton.addEventListener('click', handleQuery);
        promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleQuery(); } });

        // --- Main Functions ---
        async function handleQuery() {
            const query = promptInput.value.trim();
            if (!query) { errorMessage.textContent = 'Por favor, describe el diseño que imaginas.'; return; }

            const pricingKeywords = /\b(precio|costo|cotiza|cotización|cuánto cuesta)\b/i;
            if (pricingKeywords.test(query)) {
                contactModal.classList.remove('hidden');
                speak("En YAN'Z SMART WOOD, cada diseño es una obra de arte. Para ofrecerte una cotización precisa, te invito a contactar a nuestros especialistas.");
                return;
            }
            
            setLoading(true, 'Analizando tu visión...');
            
            try {
                const response = await callVercelAPI({ prompt: query, task: 'full_generation' });
                if(response.error) throw new Error(response.error);

                if (response.type === 'safety_violation') {
                    const safetyMessage = "Mi pasión es dar vida a espacios y muebles únicos con YAN'Z SMART WOOD. No puedo generar contenido sobre otros temas. ¿Por qué no exploramos juntos una idea de diseño para tu hogar?";
                    document.getElementById('safety-message').innerText = safetyMessage;
                    safetyModal.classList.remove('hidden');
                    speak(safetyMessage);
                    return;
                }
                
                if(response.textResult && response.imageResult) {
                    displayDesignResult(response.textResult);
                    originalImagePrompt = `Fotografía profesional de diseño de interiores con efectos visuales cinematográficos, 8k, fotorrealista. Concepto: "${response.textResult.title}". Estilo: ${query}. Descripción: ${response.textResult.description}`;
                    displayGeneratedImage(response.imageResult);
                } else {
                    throw new Error("La respuesta de la IA no fue válida.");
                }

            } catch (err) {
                console.error("Error completo:", err);
                errorMessage.textContent = `Error: ${err.message}`;
            } finally {
                setLoading(false);
            }
        }
        
        async function callVercelAPI(body) {
             const response = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: `El servidor respondió con un error: ${response.status}` }));
                throw new Error(errorData.error || `Error desconocido del servidor.`);
            }
            return response.json();
        }

        function setLoading(isLoading, message = '') {
            errorMessage.textContent = '';
            generateButton.disabled = isLoading;
            if (isLoading) {
                generateButton.innerHTML = `<div class="mx-auto h-5 w-5 animate-spin rounded-full border-2 border-solid border-black border-t-transparent"></div>`;
                videoLoader.classList.remove('hidden');
                videoLoader.classList.add('flex');
                loadingMessage.textContent = message;
                ariaContainer.classList.remove('hidden');
                formContainer.classList.add('hidden');
                ariaVideo.play();
            } else {
                generateButton.innerHTML = `<span>Generar Concepto</span>`;
                videoLoader.classList.add('hidden');
                videoLoader.classList.remove('flex');
                ariaContainer.classList.add('hidden');
                formContainer.classList.remove('hidden');
                ariaVideo.pause();
            }
        }

        function displayDesignResult({ title, description }) {
            resultWrapper.classList.remove('hidden');
            resultContainer.innerHTML = `
                <div class="w-full bg-black/60 backdrop-blur-md rounded-2xl shadow-xl border border-gray-700 animate-fade-in overflow-hidden">
                    <div id="image-container" class="bg-black/30 flex items-center justify-center p-4 min-h-[250px] sm:min-h-[400px]">
                        <div class="loader"></div>
                    </div>
                    <div class="p-6 sm:p-8 text-left">
                        <h2 class="font-display text-2xl font-bold text-white">${title}</h2>
                        <div class="mt-4 text-gray-200 space-y-4 leading-relaxed text-sm">${description}</div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-700">
                            <h3 class="font-semibold text-white mb-2 text-center">Perfeccionar con FX</h3>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <input id="fx-prompt-input" type="text" placeholder="Ej: 'con madera más oscura' o 'quita un mueble'" class="w-full px-4 py-2 text-sm bg-white/10 border border-gray-500 rounded-lg focus:ring-2 focus:ring-indigo-400 focus:outline-none transition duration-200 placeholder:text-gray-400">
                                <button id="regenerate-fx-button" class="w-full sm:w-auto bg-white/10 backdrop-blur-sm text-white border border-white/50 font-semibold rounded-lg px-5 py-2 hover:bg-white hover:text-black transition-all duration-300 text-sm flex-shrink-0 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10 3.5a1.5 1.5 0 01.954 2.723l-5.88 5.88a1.5 1.5 0 01-2.122-2.12l5.88-5.88A1.5 1.5 0 0110 3.5zM3.443 12.557l5.88-5.88a.5.5 0 01.707.707l-5.88 5.88a.5.5 0 01-.707-.707zM10 16.5a1.5 1.5 0 01-1.06-.44l-5.88-5.88a1.5 1.5 0 112.12-2.12l5.88 5.88A1.5 1.5 0 0110 16.5z" /></svg>
                                    <span>Aplicar FX</span>
                                </button>
                            </div>
                        </div>

                        <div id="details-container" class="mt-6 pt-6 border-t border-gray-700"></div>
                        <div id="details-button-container" class="text-center mt-6">
                           <button id="get-details-button" class="bg-white text-black font-semibold rounded-full px-6 py-2.5 hover:bg-gray-200 transition-all duration-300 text-sm flex items-center justify-center gap-2">
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM10 15a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 15zM10 7a3 3 0 100 6 3 3 0 000-6zM15.657 5.404a.75.75 0 10-1.06-1.06l-1.061 1.06a.75.75 0 001.06 1.06l1.06-1.06zM5.404 15.657a.75.75 0 10-1.06-1.06l-1.06 1.06a.75.75 0 001.06 1.06l1.06-1.06zM16.75 10a.75.75 0 01-1.5 0h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 011.5 0zM5.75 10a.75.75 0 01-1.5 0h-1.5a.75.75 0 010-1.5h1.5a.75.75 0 011.5 0zM14.596 14.596a.75.75 0 001.06 1.06l1.06-1.06a.75.75 0 00-1.06-1.06l-1.06 1.06zM4.343 4.343a.75.75 0 001.06 1.06l1.06-1.06a.75.75 0 00-1.06-1.06l-1.06 1.06z" /></svg>
                               <span>Ver Ideas de YAN'Z</span>
                           </button>
                        </div>
                        <div class="text-center mt-8">
                           <button id="close-result" class="pill-button">Volver</button>
                        </div>
                        <div class="text-center mt-8">
                            <p class="text-xs text-gray-400 italic">*Las imágenes y conceptos son representaciones artísticas. El diseño final puede variar.</p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('close-result').addEventListener('click', () => {
                resultWrapper.classList.add('hidden');
                formContainer.classList.remove('hidden');
                stopSpeech();
            });
            document.getElementById('get-details-button').addEventListener('click', (e) => {
                getDesignDetails(title, description, e.currentTarget);
            });
            document.getElementById('regenerate-fx-button').addEventListener('click', handleImageRegeneration);
             speak(title + ". " + description);
        }
        
        async function handleImageRegeneration() {
            const fxInput = document.getElementById('fx-prompt-input');
            const modificationText = fxInput.value.trim();
            if (!modificationText) {
                speak("Por favor, describe el cambio que quieres hacer.");
                return;
            }
            const regenerateButton = document.getElementById('regenerate-fx-button');
            regenerateButton.disabled = true;
            regenerateButton.innerHTML = '<div class="button-loader mx-auto" style="border-color: #ffffff transparent;"></div>';

            const newImagePrompt = `${originalImagePrompt}. MODIFICACIÓN IMPORTANTE: ${modificationText}.`;
            
            try {
                 const response = await callVercelAPI({ prompt: newImagePrompt, task: 'image_regeneration' });
                 if(response.error) throw new Error(response.error);
                 displayGeneratedImage(response.imageResult);
            } catch(err) {
                 console.error('Error al regenerar la imagen:', err);
                 document.getElementById('image-container').innerHTML = `<p class="text-center text-red-400 p-8">No se pudo regenerar la visualización. Inténtalo de nuevo.</p>`;
            } finally {
                regenerateButton.disabled = false;
                regenerateButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10 3.5a1.5 1.5 0 01.954 2.723l-5.88 5.88a1.5 1.5 0 01-2.122-2.12l5.88-5.88A1.5 1.5 0 0110 3.5zM3.443 12.557l5.88-5.88a.5.5 0 01.707.707l-5.88 5.88a.5.5 0 01-.707-.707zM10 16.5a1.5 1.5 0 01-1.06-.44l-5.88-5.88a1.5 1.5 0 112.12-2.12l5.88 5.88A1.5 1.5 0 0110 16.5z" /></svg><span>Aplicar FX</span>`;
            }
        }

        function displayGeneratedImage(base64Image) {
            const imageContainer = document.getElementById('image-container');
            if (base64Image) {
                imageContainer.innerHTML = `<img src="data:image/png;base64,${base64Image}" alt="Visualización del diseño" class="rounded-lg object-cover shadow-lg max-h-[400px] animate-fade-in" />`;
            } else {
                imageContainer.innerHTML = `<p class="text-center text-red-400 p-8">No se pudo generar la visualización del diseño. Inténtalo de nuevo.</p>`;
            }
        }
        
        async function getDesignDetails(title, description, button) {
            button.disabled = true;
            button.innerHTML = '<div class="button-loader"></div>';
            try {
                const response = await callVercelAPI({ title, description, task: 'get_details' });
                if(response.error) throw new Error(response.error);
                
                displayDetails(response.details);
                document.getElementById('details-button-container').style.display = 'none';

            } catch (err) {
                console.error("Error al obtener detalles:", err);
                document.getElementById('details-container').innerHTML = `<p class="text-center text-red-400 text-sm">No se pudieron cargar los detalles.</p>`;
                button.disabled = false;
                button.innerHTML = '✨ Dame más detalles';
            }
        }
        
        function displayDetails(details) {
            const container = document.getElementById('details-container');
            const materialsHTML = details.materials.map(item => `<li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>${item}</span></li>`).join('');
            const furnitureHTML = details.furniture.map(item => `<li class="flex items-center gap-2"><svg class="w-4 h-4 text-green-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg><span>${item}</span></li>`).join('');
            const paletteHTML = details.palette.map(color => `<div class="flex flex-col items-center"><div class="w-10 h-10 rounded-full border-2 border-white/50 shadow-md" style="background-color: ${color.hex};"></div><span class="mt-1.5 text-xs text-gray-300 capitalize">${color.name}</span></div>`).join('');
            container.innerHTML = `<div class="animate-fade-in grid grid-cols-1 md:grid-cols-2 gap-6 text-sm text-gray-200"><div><h3 class="font-semibold text-white mb-2">Materiales Sugeridos</h3><ul class="space-y-1.5">${materialsHTML}</ul></div><div><h3 class="font-semibold text-white mb-2">Mobiliario Clave</h3><ul class="space-y-1.5">${furnitureHTML}</ul></div><div class="md:col-span-2"><h3 class="font-semibold text-white mb-3 text-center">Paleta de Colores</h3><div class="flex justify-center gap-4 md:gap-6">${paletteHTML}</div></div></div>`;
        }
        
        function speak(text) {
            stopSpeech();
            const checkVoices = setInterval(() => {
                const voices = synth.getVoices().filter(v => v.lang.startsWith('es'));
                if (voices.length > 0) {
                    clearInterval(checkVoices);
                    const utterance = new SpeechSynthesisUtterance(text);
                    const preferredVoice = voices.find(v => v.name.includes('Sabina') || v.name.includes('Paulina')) || voices.find(v => v.lang === 'es-US') || voices[0];
                    utterance.voice = preferredVoice;
                    utterance.rate = 0.95;
                    utterance.pitch = 1.0;
                    synth.speak(utterance);
                }
            }, 100);
        }
        
        function stopSpeech() { if (synth.speaking) synth.cancel(); }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
    </script>
</body>
</html>
